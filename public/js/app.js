!function e(t,i,s){function a(n,o){if(!i[n]){if(!t[n]){var l="function"==typeof require&&require;if(!o&&l)return l(n,!0);if(r)return r(n,!0);var h=new Error("Cannot find module '"+n+"'");throw h.code="MODULE_NOT_FOUND",h}var u=i[n]={exports:{}};t[n][0].call(u.exports,function(e){var i=t[n][1][e];return a(i?i:e)},u,u.exports,e,t,i,s)}return i[n].exports}for(var r="function"==typeof require&&require,n=0;n<s.length;n++)a(s[n]);return a}({1:[function(e,t,i){"use strict";function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var a=function(){function e(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,i,s){return i&&e(t.prototype,i),s&&e(t,s),t}}();Object.defineProperty(i,"__esModule",{value:!0});i.Client=function(){function e(t){s(this,e);var i,a=window.location;i="https:"===a.protocol?"wss:":"ws:",i+="//"+a.host,i+=a.pathname+"ws",this.gameState=t,this.socket=new WebSocket(i),this.sessionToken=window.sessionStorage.getItem("_token");var r=this;this.socket.onmessage=function(e){var t=JSON.parse(e.data);switch(t.Type){case"xy":r.handleXyMessage(t);break;case"move_res":r.handleMoveResMessage(t);break;case"ok":console.log("server OK: "+e.data);break;case"tick":r.gameState.setServerTime(t.Time);break;case"msg":r.gameState.messageToLog({time:t.Time,text:t.Message});break;default:console.log("<-recv- "+e.data),console.log("unknown command from server: "+t.Type)}},this.socket.onopen=function(){console.log("Websocket connected"),r.sessionToken?(console.log("Resuming session"),this.send("continue "+r.sessionToken)):this.send("new_player "+r.gameState.playerName)}}return a(e,[{key:"sendMove",value:function(){var e=Math.floor(this.gameState.playerSprite.x/this.gameState.tileWidth/this.gameState.worldScale.x),t=Math.floor(this.gameState.playerSprite.y/this.gameState.tileHeight/this.gameState.worldScale.y);(this.prevX!=e||this.prevY!=t)&&(this.socket.send("move "+e+" "+t+" "+this.sessionToken),this.prevX=e,this.prevY=t)}},{key:"handleXyMessage",value:function(e){this.gameState.spawnPlayer(e),this.sessionToken=e.Token,window.sessionStorage.setItem("_token",e.Token)}},{key:"handleMoveResMessage",value:function(e){this.gameState.renderLocalSpawns(e.LocalSpawns)}}]),e}()},{}],2:[function(e,t,i){"use strict";function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==("undefined"==typeof t?"undefined":n(t))&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+("undefined"==typeof t?"undefined":n(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},o=function(){function e(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,i,s){return i&&e(t.prototype,i),s&&e(t,s),t}}();Object.defineProperty(i,"__esModule",{value:!0}),i.GameState=void 0;var l=e("./Client.js"),h=e("./MessageLog.js"),u=e("./GameTime.js");i.GameState=function(e){function t(){return s(this,t),a(this,Object.getPrototypeOf(t).apply(this,arguments))}return r(t,e),o(t,[{key:"preload",value:function(){this.game.time.advancedTiming=!0,this.game.stage.backgroundColor="#262f71",this.game.load.tilemap("islandMap","/island/full",null,Phaser.Tilemap.TILED_JSON),this.game.load.image("ground","img/tileset/oddball/ground.png",4,8),this.game.load.image("minimap","img/islands/current.png"),this.game.load.atlas("characterAtlas","img/tileset/oddball/characters.png","sprite/character"),this.game.load.atlas("itemAtlas","img/tileset/oddball/items.png","sprite/item"),this.game.load.atlas("ground2Atlas","img/tileset/oddball/ground2.png","sprite/ground2"),this.game.load.spritesheet("button","img/tileset/ui/buttons.png",27,24),this.game.load.image("oddballFont","img/tileset/oddball/font.png"),this.game.scale.scaleMode=Phaser.ScaleManager.RESIZE,this.game.stage.disableVisibilityChange=!0}},{key:"create",value:function(){this.playerName="Jimpson",this.worldScale={x:7,y:7},this.tileWidth=8,this.tileHeight=4,this.maxMessages=15,this.logTextHeight=15,this.minimapScale=3,this.serverTime=new u.GameTime(0),this.game.physics.startSystem(Phaser.Physics.ARCADE),this.initUi(),this.game.input.keyboard.addCallbacks(this,null,null,function(e){switch(e){case"t":return void(this.ui.visible=!this.ui.visible);default:return void console.log("unhandled char "+e)}}),this.client=new l.Client(this)}},{key:"update",value:function(){if(this.playerSprite){this.playerSprite.body.velocity.x=0,this.playerSprite.body.velocity.y=0,this.game.physics.arcade.collide(this.playerSprite,this.groundLayer);var e=200,t=e/2;this.cursors.up.isDown?(this.playerSprite.body.velocity.y=-t,this.client.sendMove()):this.cursors.down.isDown&&(this.playerSprite.body.velocity.y=t,this.client.sendMove()),this.cursors.left.isDown?(this.playerSprite.body.velocity.x=-e,this.client.sendMove()):this.cursors.right.isDown&&(this.playerSprite.body.velocity.x=e,this.client.sendMove())}}},{key:"render",value:function(){this.game.debug.text(this.game.time.fps||"--",1,14,"#00ff00"),this.playerSprite}},{key:"messageToLog",value:function(e){this.logMessageList.text=this.messageLog.add(e).render()}},{key:"initUi",value:function(){this.groundMap=this.game.add.tilemap("islandMap"),this.groundMap.addTilesetImage("island_tiles","ground"),this.groundLayer=this.groundMap.createLayer(0),this.groundLayer.scale=this.worldScale,this.groundLayer.resizeWorld(),this.groundMap.setCollisionBetween(25,80),this.spawnLayer=this.game.add.group(),this.spawnLayer.scale=this.worldScale,this.ui=this.game.add.group(),this.ui.fixedToCamera=!0,this.cursors=this.game.input.keyboard.createCursorKeys(),this.info=this.game.add.text(16,16," "),this.info.font="Courier",this.info.fontSize=14,this.info.fill="#fff",this.info.lineSpacing=-10,this.info.setShadow(2,2),this.ui.add(this.info),this.minimap=this.game.add.sprite(0,0,"minimap"),this.minimap.scale.set(1/this.minimapScale),this.minimap.alpha=.8,this.ui.add(this.minimap),this.muteButton=this.game.add.button(0,2,"button",function(){this.music.isPlaying?this.music.stop():this.music.play()},this,0,0,0),this.ui.add(this.muteButton);var e={font:"10px topaz",fill:"#fff",backgroundColor:"rgba(0,0,0,0.25)",wordWrap:!0,wordWrapWidth:400};this.logMessageList=this.game.add.text(0,0,"",e),this.logMessageList.stroke="#000",this.logMessageList.strokeThickness=2,this.logMessageList.lineSpacing=-8,this.ui.add(this.logMessageList),this.messageLog=new h.MessageLog,this.logMessageList.text=this.messageLog.render(),this.timeOfDayIcon=this.game.add.text(0,0,"",{fill:"#fff",font:"18px weathericons"}),this.timeOfDayIcon.stroke="#000",this.timeOfDayIcon.strokeThickness=2,this.ui.add(this.timeOfDayIcon),this.serverTimeText=this.game.add.text(0,0,"",e),this.ui.add(this.serverTimeText),this.resize(this.game.width,this.game.height)}},{key:"resize",value:function(e,t){this.minimap.x=e-this.game.cache.getImage("minimap").width/this.minimapScale,this.muteButton.x=e-102,this.logMessageList.x=e-400,this.logMessageList.y=t-this.maxMessages*this.logTextHeight,this.timeOfDayIcon.x=e-150,this.serverTimeText.x=e-230,this.game.scale.refresh()}},{key:"setServerTime",value:function(e){this.serverTime.set(e),this.serverTime.time&&(this.serverTimeText.text=this.serverTime.render(),this.updateTimeOfDayIcon()),this.messageLog.save()}},{key:"updateTimeOfDayIcon",value:function(){var e=this.serverTime.hour();e>=12&&(e-=12);var t=["","","","","","","","","","","",""],i=t[e];i+=this.serverTime.isDaytime()?" ":" ",this.timeOfDayIcon.text=i+" "}},{key:"spawnPlayer",value:function(e){this.playerSprite=this.game.add.sprite(0,0,"characterAtlas"),this.playerSprite.scale=this.worldScale,this.game.physics.enable(this.playerSprite,Phaser.Physics.ARCADE),this.playerSprite.frameName="dwarf",this.playerSprite.anchor.set(.5),this.game.camera.follow(this.playerSprite),this.playerSprite.body.tilePadding.set(32,32),this.playerSprite.x=e.X*this.tileWidth*this.worldScale.x,this.playerSprite.y=e.Y*this.tileHeight*this.worldScale.y,console.log("spawned at "+e.X+", "+e.Y),this.renderLocalSpawns(e.LocalSpawns)}},{key:"renderLocalSpawns",value:function(e){this.spawnLayer.removeAll();for(var t="",i=0;i<e.length;i++){var s=e[i];if("player"!=s.Class||s.Name!=this.playerName){var a=s.Sprite.split(":");switch(a[0]){case"c":t="characterAtlas";break;case"i":t="itemAtlas";break;case"g":t="ground2Atlas";break;default:console.log("ERROR unknown sprite: "+s.Sprite),console.log(s);continue}var r=this.game.add.sprite(0,0,t);r.x=s.X*this.tileWidth,r.y=s.Y*this.tileHeight,r.frameName=a[1],r.anchor.set(.5),this.spawnLayer.add(r)}}}},{key:"makeText",value:function(e){var t="                                !\"#$%&'()  ,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~",i=this.game.add.retroFont("oddballFont",8,8,t,16);return i.autoUpperCase=!1,i.text=e,i}},{key:"updateShadowTexture",value:function(){this.shadowTexture.context.fillStyle="rgb(100, 100, 100)",this.shadowTexture.context.fillRect(0,0,this.game.width,this.game.height);var e=this.shadowTexture.context.createRadialGradient(this.playerGroup.x,this.playerGroup.y,.75*this.LIGHT_RADIUS,this.playerGroup.x,this.playerGroup.y,this.LIGHT_RADIUS);e.addColorStop(0,"rgba(255, 255, 255, 1.0)"),e.addColorStop(1,"rgba(255, 255, 255, 0.0)"),this.shadowTexture.context.beginPath(),this.shadowTexture.context.fillStyle=e,this.shadowTexture.context.arc(this.playerGroup.x,this.playerGroup.y,this.LIGHT_RADIUS,0,2*Math.PI),this.shadowTexture.context.fill(),this.shadowTexture.dirty=!0}}]),t}(Phaser.State)},{"./Client.js":1,"./GameTime.js":3,"./MessageLog.js":4}],3:[function(e,t,i){"use strict";function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var a=function(){function e(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,i,s){return i&&e(t.prototype,i),s&&e(t,s),t}}();Object.defineProperty(i,"__esModule",{value:!0});var r=i.Minute=1,n=i.Hour=60*r,o=i.Day=24*n,l=i.Month=30*o,h=(i.Season=3*l,i.Year=12*l);i.GameTime=function(){function e(t){s(this,e),this.set(t)}return a(e,[{key:"set",value:function(e){this.time=e}},{key:"render",value:function(){var e=this.dateParts();return("00"+e.Hour).slice(-2)+":"+("00"+e.Minute).slice(-2)}},{key:"minute",value:function(){var e=this.dateParts();return e.Minute}},{key:"hour",value:function(){var e=this.dateParts();return e.Hour}},{key:"isDaytime",value:function(){var e=this.hour();return e>=6&&17>=e?!0:!1}},{key:"dateParts",value:function(){var e=this.time,t=Math.floor(e/h);t>0&&(e-=t*h);var i=Math.floor(e/l);i>0&&(e-=i*l);var s=Math.floor(e/o);s>0&&(e-=s*o),s++;var a=Math.floor(e/n);a>0&&(e-=a*n);var r=e;return{Minute:r,Hour:a,Day:s,Month:i,Year:t}}}]),e}()},{}],4:[function(e,t,i){"use strict";function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var a=function(){function e(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,i,s){return i&&e(t.prototype,i),s&&e(t,s),t}}();Object.defineProperty(i,"__esModule",{value:!0}),i.MessageLog=void 0;var r=e("./GameTime.js");i.MessageLog=function(){function e(){s(this,e),this.logMessages=[{time:0,text:"Welcome to roguer!"}],this.isDirty=!1;var t=window.sessionStorage.getItem("_messages");t&&(this.logMessages=JSON.parse(t))}return a(e,[{key:"add",value:function(e){return this.logMessages?(this.logMessages.push(e),this.isDirty=!0,this):(console.log("error: log wnd not yet ready!"),void console.log(e))}},{key:"save",value:function(){this.isDirty&&(this.isDirty=!1,window.sessionStorage.setItem("_messages",JSON.stringify(this.logMessages)))}},{key:"render",value:function(){if(!this.logMessages)return void console.log("error: log messages not yet ready!");this.logMessages=this.logMessages.slice(-this.maxMessages);var e="",t=!0,i=!1,s=void 0;try{for(var a,n=this.logMessages[Symbol.iterator]();!(t=(a=n.next()).done);t=!0){var o=a.value,l=new r.GameTime(o.time);e=e+l.render()+": "+o.text+"\n"}}catch(h){i=!0,s=h}finally{try{!t&&n["return"]&&n["return"]()}finally{if(i)throw s}}return e.trim()}}]),e}()},{"./GameTime.js":3}],5:[function(e,t,i){"use strict";function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==("undefined"==typeof t?"undefined":n(t))&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+("undefined"==typeof t?"undefined":n(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},o=e("./GameState.js"),l=function(e){function t(){s(this,t);var e=window.innerWidth,i=window.innerHeight,r=a(this,Object.getPrototypeOf(t).call(this,e,i,Phaser.CANVAS,"",null,!1,!1));return r.state.add("GameState",o.GameState,!1),r.state.start("GameState"),r}return r(t,e),t}(Phaser.Game);new l},{"./GameState.js":2}]},{},[5]);
//# sourceMappingURL=app.js.map
