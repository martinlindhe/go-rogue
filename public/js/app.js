!function e(t,i,s){function a(r,o){if(!i[r]){if(!t[r]){var l="function"==typeof require&&require;if(!o&&l)return l(r,!0);if(n)return n(r,!0);var h=new Error("Cannot find module '"+r+"'");throw h.code="MODULE_NOT_FOUND",h}var u=i[r]={exports:{}};t[r][0].call(u.exports,function(e){var i=t[r][1][e];return a(i?i:e)},u,u.exports,e,t,i,s)}return i[r].exports}for(var n="function"==typeof require&&require,r=0;r<s.length;r++)a(s[r]);return a}({1:[function(e,t,i){"use strict";function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var a=function(){function e(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,i,s){return i&&e(t.prototype,i),s&&e(t,s),t}}();Object.defineProperty(i,"__esModule",{value:!0});i.Client=function(){function e(t){s(this,e);var i,a=window.location;i="https:"===a.protocol?"wss:":"ws:",i+="//"+a.host,i+=a.pathname+"ws",this.gameState=t,this.socket=new WebSocket(i),this.sessionToken=window.sessionStorage.getItem("_token");var n=this;this.socket.onmessage=function(e){var t=JSON.parse(e.data);switch(t.Type){case"xy":n.handleXyMessage(t);break;case"move_res":n.handleMoveResMessage(t);break;case"ok":console.log("server OK: "+e.data);break;case"tick":n.gameState.setServerTime(t.Time);break;case"msg":n.gameState.messageToLog({time:t.Time,text:t.Message});break;default:console.log("<-recv- "+e.data),console.log("unknown command from server: "+t.Type)}},this.socket.onopen=function(){console.log("Websocket connected"),n.sessionToken?(console.log("Resuming session"),this.send("continue "+n.sessionToken)):this.send("new_player "+n.gameState.playerName)}}return a(e,[{key:"sendMove",value:function(){var e=Math.floor(this.gameState.playerSprite.x/this.gameState.tileWidth/this.gameState.worldScale.x),t=Math.floor(this.gameState.playerSprite.y/this.gameState.tileHeight/this.gameState.worldScale.y);(this.prevX!=e||this.prevY!=t)&&(this.socket.send("move "+e+" "+t+" "+this.sessionToken),this.prevX=e,this.prevY=t)}},{key:"handleXyMessage",value:function(e){this.gameState.spawnPlayer(e),this.sessionToken=e.Token,window.sessionStorage.setItem("_token",e.Token)}},{key:"handleMoveResMessage",value:function(e){this.gameState.renderLocalSpawns(e.LocalSpawns)}}]),e}()},{}],2:[function(e,t,i){"use strict";function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==("undefined"==typeof t?"undefined":r(t))&&"function"!=typeof t?e:t}function n(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+("undefined"==typeof t?"undefined":r(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},o=function(){function e(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,i,s){return i&&e(t.prototype,i),s&&e(t,s),t}}();Object.defineProperty(i,"__esModule",{value:!0}),i.GameState=void 0;var l=e("./Client.js"),h=e("./MessageLog.js"),u=e("./GameTime.js");i.GameState=function(e){function t(){return s(this,t),a(this,Object.getPrototypeOf(t).apply(this,arguments))}return n(t,e),o(t,[{key:"preload",value:function(){this.game.time.advancedTiming=!0,this.game.stage.backgroundColor="#262f71",this.game.load.tilemap("islandMap","/island/full",null,Phaser.Tilemap.TILED_JSON),this.game.load.image("ground","img/tileset/oddball/ground.png",4,8),this.game.load.image("minimap","img/islands/current.png"),this.game.load.atlas("characterAtlas","img/tileset/oddball/characters.png","sprite/character"),this.game.load.atlas("itemAtlas","img/tileset/oddball/items.png","sprite/item"),this.game.load.atlas("ground2Atlas","img/tileset/oddball/ground2.png","sprite/ground2"),this.game.load.spritesheet("button","img/tileset/ui/buttons.png",27,24),this.game.load.image("oddballFont","img/tileset/oddball/font.png"),this.game.scale.scaleMode=Phaser.ScaleManager.RESIZE,this.game.stage.disableVisibilityChange=!0}},{key:"create",value:function(){this.playerName="Jimpson",this.worldScale={x:7,y:7},this.deadzonePadding=100,this.tileWidth=8,this.tileHeight=4,this.maxMessageLines=15,this.logTextHeight=15,this.minimapScale=3,this.serverTime=new u.GameTime(0),this.game.physics.startSystem(Phaser.Physics.ARCADE),this.initUi(),this.game.input.keyboard.addCallbacks(this,null,null,function(e){switch(e){case"t":return void(this.ui.visible=!this.ui.visible);case"d":return console.log("debug collision toggle"),console.log(this.groundLayer.debug),void(this.groundLayer.debug=!this.groundLayer.debug);default:return void console.log("unhandled char "+e)}}),this.client=new l.Client(this)}},{key:"update",value:function(){if(this.playerSprite){this.game.physics.arcade.collide(this.playerSprite,this.groundLayer,function(){console.log("collision")}),this.playerSprite.body.velocity.x=0,this.playerSprite.body.velocity.y=0;var e=1600,t=e/2;this.cursors.up.isDown?(this.playerSprite.body.velocity.y=-t,this.client.sendMove()):this.cursors.down.isDown&&(this.playerSprite.body.velocity.y=t,this.client.sendMove()),this.cursors.left.isDown?(this.playerSprite.body.velocity.x=-e,this.client.sendMove()):this.cursors.right.isDown&&(this.playerSprite.body.velocity.x=e,this.client.sendMove())}}},{key:"render",value:function(){this.game.debug.text(this.game.time.fps||"--",1,14,"#00ff00"),this.playerSprite&&(this.game.debug.bodyInfo(this.playerSprite,10,this.game.height-100),this.game.debug.body(this.playerSprite,"rgba(0,255,0,0.4)",!0))}},{key:"messageToLog",value:function(e){this.logMessageList.text=this.messageLog.add(e).render()}},{key:"initUi",value:function(){this.groundMap=this.game.add.tilemap("islandMap"),this.groundMap.addTilesetImage("island_tiles","ground"),this.groundLayer=this.groundMap.createLayer(0),this.groundLayer.scale=this.worldScale,this.groundLayer.resizeWorld(),this.groundMap.setCollisionBetween(0,60),this.game.physics.arcade.enable(this.groundLayer),this.spawnLayer=this.game.add.group(),this.spawnLayer.scale=this.worldScale,this.ui=this.game.add.group(),this.ui.fixedToCamera=!0,this.cursors=this.game.input.keyboard.createCursorKeys(),this.info=this.game.add.text(16,16," "),this.info.font="Courier",this.info.fontSize=14,this.info.fill="#fff",this.info.lineSpacing=-10,this.info.setShadow(2,2),this.ui.add(this.info),this.minimap=this.game.add.sprite(0,0,"minimap"),this.minimap.scale.set(1/this.minimapScale),this.minimap.alpha=.8,this.ui.add(this.minimap),this.muteButton=this.game.add.button(0,2,"button",function(){this.music.isPlaying?this.music.stop():this.music.play()},this,0,0,0),this.ui.add(this.muteButton);var e={font:"10px topaz",fill:"#fff",backgroundColor:"rgba(0,0,0,0.25)",wordWrap:!0,wordWrapWidth:400};this.logMessageList=this.game.add.text(0,0,"",e),this.logMessageList.stroke="#000",this.logMessageList.strokeThickness=2,this.logMessageList.lineSpacing=-8,this.ui.add(this.logMessageList),this.messageLog=new h.MessageLog(this.maxMessageLines),this.logMessageList.text=this.messageLog.render(),this.timeOfDayIcon=this.game.add.text(0,0,"",{fill:"#fff",font:"18px weathericons"}),this.timeOfDayIcon.stroke="#000",this.timeOfDayIcon.strokeThickness=2,this.ui.add(this.timeOfDayIcon),this.serverTimeText=this.game.add.text(0,0,"",e),this.ui.add(this.serverTimeText),this.resize(this.game.width,this.game.height)}},{key:"resize",value:function(e,t){this.minimap.x=e-this.game.cache.getImage("minimap").width/this.minimapScale,this.muteButton.x=e-102,this.logMessageList.x=e-400,this.logMessageList.y=t-this.maxMessageLines*this.logTextHeight,this.timeOfDayIcon.x=e-150,this.serverTimeText.x=e-230,this.game.camera.deadzone=new Phaser.Rectangle(this.deadzonePadding,this.deadzonePadding,e-2*this.deadzonePadding,t-2*this.deadzonePadding),this.game.scale.refresh()}},{key:"setServerTime",value:function(e){this.serverTime.set(e),this.serverTime.time&&(this.serverTimeText.text=this.serverTime.render(),this.updateTimeOfDayIcon()),this.messageLog.save()}},{key:"updateTimeOfDayIcon",value:function(){var e=this.serverTime.hour();e>=12&&(e-=12);var t=["","","","","","","","","","","",""],i=t[e];i+=this.serverTime.isDaytime()?" ":" ",this.timeOfDayIcon.text=i+" "}},{key:"spawnPlayer",value:function(e){this.playerSprite=this.game.add.sprite(0,0,"characterAtlas"),this.playerSprite.scale=this.worldScale,this.playerSprite.frameName="dwarf",this.playerSprite.anchor.setTo(.5,.5),this.playerSprite.x=e.X*this.tileWidth*this.worldScale.x,this.playerSprite.y=e.Y*this.tileHeight*this.worldScale.y,this.game.physics.arcade.enable(this.playerSprite),this.playerSprite.body.setSize(10,14,2,1),this.playerSprite.body.collideWorldBounds=!0,this.game.camera.follow(this.playerSprite),this.game.camera.deadzone=new Phaser.Rectangle(this.deadzonePadding,this.deadzonePadding,this.game.width-2*this.deadzonePadding,this.game.height-2*this.deadzonePadding),console.log("spawned at "+e.X+", "+e.Y),this.renderLocalSpawns(e.LocalSpawns)}},{key:"renderLocalSpawns",value:function(e){this.spawnLayer.removeAll();for(var t="",i=0;i<e.length;i++){var s=e[i];if("player"!=s.Class||s.Name!=this.playerName){var a=s.Sprite.split(":");switch(a[0]){case"c":t="characterAtlas";break;case"i":t="itemAtlas";break;case"g":t="ground2Atlas";break;default:console.log("ERROR unknown sprite: "+s.Sprite),console.log(s);continue}var n=this.game.add.sprite(0,0,t);n.x=s.X*this.tileWidth,n.y=s.Y*this.tileHeight,n.frameName=a[1],n.anchor.set(.5),this.spawnLayer.add(n)}}}},{key:"makeText",value:function(e){var t="                                !\"#$%&'()  ,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~",i=this.game.add.retroFont("oddballFont",8,8,t,16);return i.autoUpperCase=!1,i.text=e,i}},{key:"updateShadowTexture",value:function(){this.shadowTexture.context.fillStyle="rgb(100, 100, 100)",this.shadowTexture.context.fillRect(0,0,this.game.width,this.game.height);var e=this.shadowTexture.context.createRadialGradient(this.playerSprite.x,this.playerSprite.y,.75*this.LIGHT_RADIUS,this.playerSprite.x,this.playerSprite.y,this.LIGHT_RADIUS);e.addColorStop(0,"rgba(255, 255, 255, 1.0)"),e.addColorStop(1,"rgba(255, 255, 255, 0.0)"),this.shadowTexture.context.beginPath(),this.shadowTexture.context.fillStyle=e,this.shadowTexture.context.arc(this.playerSprite.x,this.playerSprite.y,this.LIGHT_RADIUS,0,2*Math.PI),this.shadowTexture.context.fill(),this.shadowTexture.dirty=!0}}]),t}(Phaser.State)},{"./Client.js":1,"./GameTime.js":3,"./MessageLog.js":4}],3:[function(e,t,i){"use strict";function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var a=function(){function e(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,i,s){return i&&e(t.prototype,i),s&&e(t,s),t}}();Object.defineProperty(i,"__esModule",{value:!0});var n=i.Minute=1,r=i.Hour=60*n,o=i.Day=24*r,l=i.Month=30*o,h=(i.Season=3*l,i.Year=12*l);i.GameTime=function(){function e(t){s(this,e),this.set(t)}return a(e,[{key:"set",value:function(e){this.time=e}},{key:"render",value:function(){var e=this.dateParts();return("00"+e.Hour).slice(-2)+":"+("00"+e.Minute).slice(-2)}},{key:"minute",value:function(){var e=this.dateParts();return e.Minute}},{key:"hour",value:function(){var e=this.dateParts();return e.Hour}},{key:"isDaytime",value:function(){var e=this.hour();return e>=6&&17>=e?!0:!1}},{key:"dateParts",value:function(){var e=this.time,t=Math.floor(e/h);t>0&&(e-=t*h);var i=Math.floor(e/l);i>0&&(e-=i*l);var s=Math.floor(e/o);s>0&&(e-=s*o),s++;var a=Math.floor(e/r);a>0&&(e-=a*r);var n=e;return{Minute:n,Hour:a,Day:s,Month:i,Year:t}}}]),e}()},{}],4:[function(e,t,i){"use strict";function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var a=function(){function e(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,i,s){return i&&e(t.prototype,i),s&&e(t,s),t}}();Object.defineProperty(i,"__esModule",{value:!0}),i.MessageLog=void 0;var n=e("./GameTime.js");i.MessageLog=function(){function e(t){s(this,e),this.maxMessageLines=t,this.logMessages=[{time:0,text:"Welcome to roguer!"}],this.isDirty=!1;var i=window.sessionStorage.getItem("_messages");i&&(this.logMessages=JSON.parse(i))}return a(e,[{key:"add",value:function(e){return this.logMessages?(this.logMessages.push(e),this.isDirty=!0,this):(console.log("error: log wnd not yet ready!"),void console.log(e))}},{key:"save",value:function(){this.isDirty&&(this.isDirty=!1,window.sessionStorage.setItem("_messages",JSON.stringify(this.logMessages)))}},{key:"render",value:function(){if(!this.logMessages)return void console.log("error: log messages not yet ready!");var e=this.logMessages.slice(-this.maxMessageLines),t="",i=!0,s=!1,a=void 0;try{for(var r,o=e[Symbol.iterator]();!(i=(r=o.next()).done);i=!0){var l=r.value,h=new n.GameTime(l.time);t=t+h.render()+": "+l.text+"\n"}}catch(u){s=!0,a=u}finally{try{!i&&o["return"]&&o["return"]()}finally{if(s)throw a}}return t.trim()}}]),e}()},{"./GameTime.js":3}],5:[function(e,t,i){"use strict";function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==("undefined"==typeof t?"undefined":r(t))&&"function"!=typeof t?e:t}function n(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+("undefined"==typeof t?"undefined":r(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},o=e("./GameState.js"),l=function(e){function t(){s(this,t);var e=window.innerWidth,i=window.innerHeight,n=a(this,Object.getPrototypeOf(t).call(this,e,i,Phaser.CANVAS,"",null,!1,!1));return n.state.add("GameState",o.GameState,!1),n.state.start("GameState"),n}return n(t,e),t}(Phaser.Game);new l},{"./GameState.js":2}]},{},[5]);
//# sourceMappingURL=app.js.map
